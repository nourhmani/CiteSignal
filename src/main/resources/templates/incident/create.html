<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Déclarer un incident - CiteSignal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --dark-color: #1e293b;
            --light-bg: #f8fafc;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--light-bg);
            min-height: 100vh;
        }

        /* Navigation moderne */
        .top-navbar {
            background: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .navbar-brand {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-decoration: none;
        }

        .btn-back {
            padding: 10px 20px;
            background: var(--light-bg);
            color: var(--dark-color);
            border: none;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
        }

        .btn-back:hover {
            background: #e2e8f0;
            color: var(--dark-color);
            text-decoration: none;
        }

        /* Conteneur principal */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* En-tête de page */
        .page-header {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }

        .breadcrumb {
            background: none;
            padding: 0;
            margin-bottom: 15px;
        }

        .breadcrumb-item {
            font-size: 14px;
            color: #64748b;
        }

        .breadcrumb-item.active {
            color: var(--primary-color);
            font-weight: 600;
        }

        .breadcrumb-item a {
            color: #64748b;
            text-decoration: none;
        }

        .breadcrumb-item a:hover {
            color: var(--primary-color);
            text-decoration: none;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--dark-color);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }

        .page-title i {
            margin-right: 12px;
            color: var(--warning-color);
        }

        .page-subtitle {
            color: #64748b;
            font-size: 15px;
        }

        /* Carte de formulaire */
        .form-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            margin-bottom: 40px;
        }

        .form-body {
            padding: 40px;
        }

        /* Styles de formulaire */
        .form-section-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark-color);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-bg);
            display: flex;
            align-items: center;
        }

        .form-section-title i {
            margin-right: 10px;
            color: var(--primary-color);
        }

        .form-label {
            color: var(--dark-color);
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }

        .form-label i {
            margin-right: 8px;
            color: var(--primary-color);
            font-size: 16px;
        }

        .required {
            color: var(--danger-color);
            margin-left: 4px;
            font-weight: 700;
        }

        .form-control, .form-select {
            padding: 14px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: #f8fafc;
        }

        .form-control:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            background: white;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        .form-text {
            color: #64748b;
            font-size: 13px;
            margin-top: 6px;
            display: flex;
            align-items: center;
        }

        .form-text i {
            margin-right: 6px;
            font-size: 12px;
        }

        /* Carte */
        .map-container {
            margin-top: 10px;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #e2e8f0;
        }

        #map {
            height: 300px;
            width: 100%;
        }

        /* Téléchargement de fichiers */
        .file-upload-container {
            margin-top: 10px;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(139, 92, 246, 0.08));
            border: 2px dashed rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            color: var(--primary-color);
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            text-align: center;
        }

        .file-input-label:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15));
            border-color: var(--primary-color);
        }

        /* Boîte d'information */
        .info-box {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(139, 92, 246, 0.08));
            border-left: 4px solid var(--primary-color);
            padding: 20px;
            border-radius: 12px;
            margin: 30px 0;
        }

        .info-box-content {
            display: flex;
            align-items: start;
            gap: 15px;
        }

        .info-icon {
            width: 45px;
            height: 45px;
            background: rgba(99, 102, 241, 0.15);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .info-icon i {
            color: var(--primary-color);
            font-size: 20px;
        }

        .info-text strong {
            color: var(--dark-color);
            font-weight: 700;
            font-size: 15px;
            display: block;
            margin-bottom: 6px;
        }

        .info-text p {
            color: #475569;
            margin: 0;
            font-size: 14px;
            line-height: 1.6;
        }

        /* Actions du formulaire */
        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            padding: 25px 40px;
            background: var(--light-bg);
            border-top: 1px solid #e2e8f0;
        }

        .btn-cancel {
            padding: 14px 30px;
            background: white;
            color: var(--dark-color);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-weight: 600;
            font-size: 15px;
            text-decoration: none;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-cancel:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
            color: var(--dark-color);
            text-decoration: none;
        }

        .btn-submit {
            padding: 14px 30px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        /* Alertes */
        .alert {
            padding: 16px 20px;
            border-radius: 12px;
            border: none;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert i {
            font-size: 20px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
        }

        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                padding: 0 15px;
            }

            .form-body {
                padding: 25px 20px;
            }

            .form-actions {
                flex-direction: column;
                padding: 20px;
            }

            .btn-cancel, .btn-submit {
                width: 100%;
                justify-content: center;
            }

            .page-header {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
<!-- Navigation supérieure -->
<nav class="top-navbar">
    <div class="main-container">
        <div class="d-flex justify-content-between align-items-center">
            <a class="navbar-brand" href="/dashboard">
                <i class="fas fa-city me-2"></i>CiteSignal
            </a>
            <a th:href="@{/dashboard}" class="btn-back">
                <i class="fas fa-arrow-left me-2"></i>Retour au tableau de bord
            </a>
        </div>
    </div>
</nav>

<!-- Contenu principal -->
<div class="main-container">
    <!-- En-tête de page -->
    <div class="page-header">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="/dashboard">
                        <i class="fas fa-home me-1"></i>Accueil
                    </a>
                </li>

                <li class="breadcrumb-item active">Déclarer un incident</li>
            </ol>
        </nav>
        <h1 class="page-title">
            <i class="fas fa-exclamation-triangle"></i>
            Déclarer un Incident
        </h1>
        <p class="page-subtitle">Signalez un problème dans votre quartier pour une intervention rapide</p>
    </div>

    <!-- Carte de formulaire -->
    <div class="form-card">
        <div class="form-body">
            <!-- Messages d'alerte -->
            <div th:if="${errorMessage}" class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-circle"></i>
                <span th:text="${errorMessage}"></span>
            </div>

            <!-- Formulaire (structure identique à l'ancienne version) -->
            <form th:action="@{/incidents/create}" th:object="${incident}" method="post" enctype="multipart/form-data">

                <!-- Section: Informations de base -->
                <h3 class="form-section-title">
                    <i class="fas fa-info-circle"></i>
                    Informations de base
                </h3>

                <div class="mb-4">
                    <label for="titre" class="form-label">
                        <i class="fas fa-heading"></i>
                        Titre de l'incident<span class="required">*</span>
                    </label>
                    <input type="text" class="form-control" id="titre" th:field="*{titre}"
                           placeholder="Ex: Éclairage public défectueux" required>
                    <div th:if="${#fields.hasErrors('titre')}" th:errors="*{titre}" class="text-danger mt-2" style="font-size: 13px;"></div>
                </div>

                <div class="mb-4">
                    <label for="description" class="form-label">
                        <i class="fas fa-align-left"></i>
                        Description détaillée<span class="required">*</span>
                    </label>
                    <textarea class="form-control" id="description" th:field="*{description}"
                              rows="5" placeholder="Décrivez précisément l'incident..." required></textarea>
                    <div th:if="${#fields.hasErrors('description')}" th:errors="*{description}" class="text-danger mt-2" style="font-size: 13px;"></div>
                    <small class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Plus votre description est précise, plus l'intervention sera efficace
                    </small>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <label for="categorie" class="form-label">
                            <i class="fas fa-tag"></i>
                            Catégorie<span class="required">*</span>
                        </label>
                        <select class="form-select" id="categorie" th:field="*{categorie}" required>
                            <option value="">Sélectionner une catégorie</option>
                            <option th:each="cat : ${categories}" th:value="${cat}" th:text="${cat}"></option>
                        </select>
                        <div th:if="${#fields.hasErrors('categorie')}" th:errors="*{categorie}" class="text-danger mt-2" style="font-size: 13px;"></div>
                    </div>

                    <div class="col-md-6">
                        <label for="priorite" class="form-label">
                            <i class="fas fa-exclamation"></i>
                            Niveau de priorité
                        </label>
                        <select class="form-select" id="priorite" th:field="*{priorite}">
                            <option th:each="prio : ${priorites}" th:value="${prio}" th:text="${prio}"></option>
                        </select>
                        <small class="form-text">
                            <i class="fas fa-info-circle"></i>
                            Évaluez l'urgence de la situation
                        </small>
                    </div>
                </div>

                <!-- Section: Localisation -->
                <h3 class="form-section-title" style="margin-top: 40px;">
                    <i class="fas fa-map-marker-alt"></i>
                    Localisation
                </h3>

                <div class="mb-4">
                    <label for="adresse" class="form-label">
                        <i class="fas fa-map-pin"></i>
                        Adresse précise<span class="required">*</span>
                    </label>
                    <input type="text" class="form-control" id="adresse" th:field="*{adresse}"
                           placeholder="Ex: Rue Habib Bourguiba, Tunis" required>
                    <div th:if="${#fields.hasErrors('adresse')}" th:errors="*{adresse}" class="text-danger mt-2" style="font-size: 13px;"></div>
                </div>

                <div class="mb-4">
                    <label class="form-label">
                        <i class="fas fa-map"></i>
                        Localisation sur la carte
                    </label>
                    <div class="map-container">
                        <div id="map"></div>
                    </div>
                    <small class="form-text">
                        <i class="fas fa-mouse-pointer"></i>
                        Cliquez sur la carte pour positionner le marqueur exact
                    </small>
                    <input type="hidden" id="latitude" th:field="*{latitude}">
                    <input type="hidden" id="longitude" th:field="*{longitude}">
                </div>

                <div class="mb-4">
                    <label for="quartierId" class="form-label">
                        <i class="fas fa-building"></i>
                        Quartier concerné
                    </label>
                    <select class="form-select" id="quartierId" th:field="*{quartierId}">
                        <option value="">Sélectionner un quartier (optionnel)</option>
                        <option th:each="quartier : ${quartiers}" th:value="${quartier.id}" th:text="${quartier.nom}"></option>
                    </select>
                    <small class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Cela aide à orienter l'incident vers le bon service municipal
                    </small>
                </div>

                <!-- Section: Preuves visuelles -->
                <h3 class="form-section-title" style="margin-top: 40px;">
                    <i class="fas fa-camera"></i>
                    Preuves visuelles
                </h3>

                <div class="mb-4">
                    <label class="form-label">
                        <i class="fas fa-images"></i>
                        Photos de l'incident
                    </label>
                    <div class="file-upload-container">
                        <input type="file" class="form-control" id="photos" name="photos" multiple accept="image/*">
                    </div>
                    <small class="form-text">
                        <i class="fas fa-info-circle"></i>
                        Formats acceptés : JPG, PNG, GIF • Max 10MB par fichier • Plusieurs fichiers possibles
                    </small>
                </div>

                <!-- Boîte d'information -->
                <div class="info-box">
                    <div class="info-box-content">
                        <div class="info-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="info-text">
                            <strong>Confidentialité et suivi</strong>
                            <p>Votre déclaration sera traitée par les services municipaux compétents. Vous recevrez un numéro de suivi et pourrez consulter l'avancement de votre demande dans votre espace personnel. Les photos que vous fournissez aideront à mieux comprendre et résoudre le problème.</p>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Actions du formulaire -->
        <div class="form-actions">
            <a th:href="@{/dashboard}" class="btn-cancel">
                <i class="fas fa-times"></i>
                Annuler
            </a>
            <button type="submit" class="btn-submit" onclick="document.forms[0].submit();">
                <i class="fas fa-paper-plane"></i>
                Déclarer l'incident
            </button>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<script>
    // Initialiser la carte Leaflet (identique à l'ancienne version)
    var map = L.map('map').setView([36.8065, 10.1815], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    var marker = null;
    map.on('click', function(e) {
        if (marker) {
            map.removeLayer(marker);
        }
        marker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
        document.getElementById('latitude').value = e.latlng.lat;
        document.getElementById('longitude').value = e.latlng.lng;
    });

    // Validation simple avant soumission
    document.querySelector('.btn-submit').addEventListener('click', function(e) {
        const latitude = document.getElementById('latitude').value;
        const longitude = document.getElementById('longitude').value;

        if (!latitude || !longitude) {
            e.preventDefault();
            alert('Veuillez cliquer sur la carte pour indiquer la localisation exacte de l\'incident.');
            map.flyTo([36.8065, 10.1815], 13);
            return false;
        }
    });

    // Amélioration visuelle pour le téléchargement de fichiers
    document.getElementById('photos').addEventListener('change', function(e) {
        const files = e.target.files;
        if (files.length > 0) {
            const input = this;
            const parent = input.parentElement;

            // Créer un label visuel
            const label = document.createElement('div');
            label.className = 'file-input-label';
            label.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    ${files.length} fichier(s) sélectionné(s)
                `;

            // Remplacer l'input existant
            parent.innerHTML = '';
            parent.appendChild(label);
            parent.appendChild(input);

            // Mettre à jour le style
            label.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.3))';
            label.style.borderColor = 'var(--success-color)';
            label.style.color = 'var(--success-color)';

            // Permettre de cliquer sur le label pour changer les fichiers
            label.addEventListener('click', function() {
                input.click();
            });
        }
    });
</script>
</body>
</html>